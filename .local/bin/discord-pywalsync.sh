#!/bin/bash

# Path
WALCSS="$HOME/.cache/wal/colors.css"
BDCSS="$HOME/.var/app/dev.vencord.Vesktop/config/vesktop/themes/custom.css"
TEMPLATE="$HOME/.var/app/dev.vencord.Vesktop/bd-template.css"
HEADER="$HOME/.var/app/dev.vencord.Vesktop/bd-header.css"

# Overwrite Better Discord Custom CSS using pywal color palette
cat "$HEADER" > "$BDCSS"
echo "" >> "$BDCSS"
cat "$WALCSS" >> "$BDCSS"
echo "" >> "$BDCSS"

# Extract current wallpaper from gsettings and generate URL variable
CURRENT_WALLPAPER=$(gsettings get org.gnome.desktop.background picture-uri-dark 2>/dev/null || echo "")
if [ -n "$CURRENT_WALLPAPER" ] && [ "$CURRENT_WALLPAPER" != "''" ]; then
    # Remove 'file://' prefix and quotes
    WALLPAPER_PATH=${CURRENT_WALLPAPER#"'file://"}
    WALLPAPER_PATH=${WALLPAPER_PATH%"'"}
    
    # Extract filename only
    WALLPAPER_NAME=$(basename "$WALLPAPER_PATH")
    
    # Generate GitHub URL and inject to CSS
    GITHUB_WALLPAPER_URL="https://raw.githubusercontent.com/SeraphimeZelel/rion-ricing/refs/heads/main/Wallpaper/$WALLPAPER_NAME"
    
    cat >> "$BDCSS" << EOF

/* Wallpaper URL - Generated by discord-pywalsync.sh */
:root {
    --wallpaper: url('$GITHUB_WALLPAPER_URL');
}
EOF
    echo "" >> "$BDCSS"
fi

cat "$TEMPLATE" >> "$BDCSS"
